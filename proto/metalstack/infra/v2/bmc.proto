syntax = "proto3";

package metalstack.infra.v2;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";
import "metalstack/api/v2/common.proto";
import "metalstack/api/v2/machine.proto";
import "metalstack/api/v2/predefined_rules.proto";

// BMCService serves bmc related functions
service BMCService {
  // UpdateBMCInfo
  rpc UpdateBMCInfo(UpdateBMCInfoRequest) returns (UpdateBMCInfoResponse) {
    option (metalstack.api.v2.infra_roles) = INFRA_ROLE_EDITOR;
    option (metalstack.api.v2.auditing) = AUDITING_EXCLUDED;
  }
  // WaitForBMCCommand is called by the metal-bmc and is returned with a bmc command to execute.
  rpc WaitForBMCCommand(WaitForBMCCommandRequest) returns (stream WaitForBMCCommandResponse) {
    option (metalstack.api.v2.infra_roles) = INFRA_ROLE_EDITOR;
    option (metalstack.api.v2.auditing) = AUDITING_EXCLUDED;
  }
  // BMCCommandDone must be called from metal-bmc after the command execution
  rpc BMCCommandDone(BMCCommandDoneRequest) returns (BMCCommandDoneResponse) {
    option (metalstack.api.v2.infra_roles) = INFRA_ROLE_EDITOR;
    option (metalstack.api.v2.auditing) = AUDITING_INCLUDED;
  }
}

// UpdateBMCInfoRequest
message UpdateBMCInfoRequest {
  // Partition the partition id where metal-bmc wants to receive events
  string partition = 1 [(buf.validate.field).string.(metalstack.api.v2.is_partition) = true];
  // BMCReports contains maps the bmc report per machine uuid
  map<string, metalstack.api.v2.MachineBMCReport> bmc_reports = 2 [(buf.validate.field).map = {
    keys: {
      string: {uuid: true}
    }
  }];
}

// UpdateBMCInfoResponse
message UpdateBMCInfoResponse {
  // UpdatedMachines is a slice of machine uuids which where updated
  repeated string updated_machines = 1;
  // CreatedMachines is a slice of machine uuids which where created
  repeated string created_machines = 2;
}

// WaitForBMCCommandRequest
message WaitForBMCCommandRequest {
  // Partition the partition id where metal-bmc wants to receive bmc commands
  string partition = 1 [(buf.validate.field).string.(metalstack.api.v2.is_partition) = true];
}

// WaitForBMCCommandResponse
message WaitForBMCCommandResponse {
  // UUID of the machine to send the command to
  string uuid = 1 [(buf.validate.field).string.uuid = true];
  // BMCCommand to execute against the bmc of the machine
  metalstack.api.v2.MachineBMCCommand bmc_command = 2;
  // MachineBMC contains connection details of the machine to issue the bmcCommand to
  metalstack.api.v2.MachineBMC machine_bmc = 3;
  // CommandId is a unique ID which must be sent back after execution
  string command_id = 4 [(buf.validate.field).string.uuid = true];
  // IssuedAt gives the date when this command was created
  google.protobuf.Timestamp issued_at = 7;
}

// BMCCommandDoneRequest must be returned after command execution
message BMCCommandDoneRequest {
  // CommandId is a unique ID which must be sent back after execution
  string command_id = 1 [(buf.validate.field).string.uuid = true];
  // Error of the command execution, nil if it was successful
  optional string error = 2;
}

// BMCCommandDoneResponse
message BMCCommandDoneResponse {}
