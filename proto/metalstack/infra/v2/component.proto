syntax = "proto3";

package metalstack.infra.v2;

import "buf/validate/validate.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
import "metalstack/api/v2/common.proto";
import "metalstack/api/v2/component.proto";
import "metalstack/api/v2/predefined_rules.proto";
import "metalstack/api/v2/version.proto";

// ComponentService serves component, e.g. microservices related functions.
service ComponentService {
  // Ping must be called from every connected microservice in a recurring manner
  // to get visibility of all registered microservices.
  rpc Ping(ComponentServicePingRequest) returns (ComponentServicePingResponse) {
    option (metalstack.api.v2.infra_roles) = INFRA_ROLE_EDITOR;
    option (metalstack.api.v2.auditing) = AUDITING_EXCLUDED;
  }
}

// ComponentServicePingRequest is sent from a microservice to report its state regularly
message ComponentServicePingRequest {
  // Type defines which service is actually pinging
  metalstack.api.v2.ComponentType type = 1 [(buf.validate.field).enum.defined_only = true];
  // Identifier is a unique identifier of this service, e.g. if two instance are running, this might be the pod id.
  // micro_service and identifier guarantee uniqueness.
  string identifier = 2 [(buf.validate.field).string.(metalstack.api.v2.is_name) = true];
  // StartedAt is the timestamp this service was started.
  google.protobuf.Timestamp started_at = 3 [(buf.validate.field).timestamp.lt_now = true];
  // Interval at which the ping is scheduled, must be between 5 seconds and 1 hour.
  // Also gets validated in the same way in go/client/ping.go.
  google.protobuf.Duration interval = 4 [(buf.validate.field).duration = {
    gte: {seconds: 5}
    lte: {seconds: 3600}
  }];
  // Version of this service
  metalstack.api.v2.Version version = 5;
}

// ComponentServicePingResponse is the response to a ping request
message ComponentServicePingResponse {}
