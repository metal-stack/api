syntax = "proto3";

package metalstack.admin.v2;

import "buf/validate/validate.proto";
import "metalstack/api/v2/common.proto";
import "metalstack/api/v2/machine.proto";
import "metalstack/api/v2/predefined_rules.proto";

// MachineService serves machine related functions
service MachineService {
  // Get a machine
  rpc Get(MachineServiceGetRequest) returns (MachineServiceGetResponse) {
    option (metalstack.api.v2.admin_roles) = ADMIN_ROLE_EDITOR;
    option (metalstack.api.v2.admin_roles) = ADMIN_ROLE_VIEWER;
    option (metalstack.api.v2.auditing) = AUDITING_EXCLUDED;
  }
  // List all machines
  rpc List(MachineServiceListRequest) returns (MachineServiceListResponse) {
    option (metalstack.api.v2.admin_roles) = ADMIN_ROLE_EDITOR;
    option (metalstack.api.v2.admin_roles) = ADMIN_ROLE_VIEWER;
    option (metalstack.api.v2.auditing) = AUDITING_EXCLUDED;
  }
  // BMCCommand send a command to the bmc of a machine
  rpc BMCCommand(MachineServiceBMCCommandRequest) returns (MachineServiceBMCCommandResponse) {
    option (metalstack.api.v2.admin_roles) = ADMIN_ROLE_EDITOR;
  }
  // GetBMC returns the BMC details of a machine
  rpc GetBMC(MachineServiceGetBMCRequest) returns (MachineServiceGetBMCResponse) {
    option (metalstack.api.v2.admin_roles) = ADMIN_ROLE_EDITOR;
    option (metalstack.api.v2.admin_roles) = ADMIN_ROLE_VIEWER;
  }
  // ListBMC returns the BMC details of many machines
  rpc ListBMC(MachineServiceListBMCRequest) returns (MachineServiceListBMCResponse) {
    option (metalstack.api.v2.admin_roles) = ADMIN_ROLE_EDITOR;
    option (metalstack.api.v2.admin_roles) = ADMIN_ROLE_VIEWER;
  }
}

// ------------------------ Service Messages ----------------------------------

// MachineServiceGetRequest is the request payload for a machine get request
message MachineServiceGetRequest {
  // UUID of the machine to get
  string uuid = 1 [(buf.validate.field).string.uuid = true];
}

// MachineServiceGetResponse is the request payload for a machine get response
message MachineServiceGetResponse {
  // Machine is the machine requested
  metalstack.api.v2.Machine machine = 1;
}

// MachineServiceListRequest is the request payload for a machine list request
message MachineServiceListRequest {
  // Query to list one ore more machines
  metalstack.api.v2.MachineQuery query = 1;
  // Partition for which machines should be listed, could be left empty if only one partition is present
  // otherwise an error is thrown that the partition must be specified
  optional string partition = 2 [(buf.validate.field).string.(metalstack.api.v2.is_partition) = true];
}

// MachineServiceListResponse is the request payload for a machine list response
message MachineServiceListResponse {
  // Machines are the machines requested by a list request
  repeated metalstack.api.v2.Machine machines = 1;
}

// MachineServiceBMCCommandRequest is the request payload for a machine bmc command
message MachineServiceBMCCommandRequest {
  // UUID of the machine to send the command to
  string uuid = 1 [(buf.validate.field).string.uuid = true];
  // Command to send to the bmc of the machine
  metalstack.api.v2.MachineBMCCommand command = 2 [(buf.validate.field).enum.defined_only = true];
}

// MachineServiceBMCCommandResponse is the response payload for a machine bmc command
message MachineServiceBMCCommandResponse {}

// MachineServiceGetBMCRequest is the request payload for a machine getbmc request
message MachineServiceGetBMCRequest {
  // UUID of the machine to get
  string uuid = 1 [(buf.validate.field).string.uuid = true];
}

// MachineServiceGetBMCResponse is the response payload for a machine getbmc request
message MachineServiceGetBMCResponse {
  // UUID of the machine
  string uuid = 1 [(buf.validate.field).string.uuid = true];
  // BMC contains the BMC details of this machine
  metalstack.api.v2.MachineBMCReport bmc = 2;
}

// MachineServiceListBMCRequest is the request payload for a machine listbmc request
message MachineServiceListBMCRequest {
  // Query to list one ore more bmcs of more machines
  metalstack.api.v2.MachineBMCQuery query = 1;
}

// MachineServiceListBMCResponse is the response payload for a machine listbmc request
message MachineServiceListBMCResponse {
  // BMCReports contains maps the bmc report per machine uuid
  map<string, metalstack.api.v2.MachineBMCReport> bmc_reports = 1 [(buf.validate.field).map = {
    keys: {
      string: {uuid: true}
    }
  }];
}
